---
title: "ACC Notebook"
output: html_notebook
---

# Set up working environment

```{R}

# Clear workspace

rm(list= ls())


```

# Long script!

this script runs the dorsal body amplitude and flap frequency algorithms

It takes over an hour to run. Most often better to:

skip to section 2


# All files which have GPS data

```{R}


files = list.files(file.path(PROJHOME, "Output", "mGPS"))

smooth_type = "num.flaps"

load( file.path( PROJHOME, "Data" , "pigeon_nums.rda"))



time.errors = vector()
no.file = vector()

for ( i in 1:length(files)){ # for each file in the mGPS folder
  
  # i = 6
  load( file.path ( PROJHOME , "Output" , "gGPS", "g2.34.rda"))
  
  fin.time = dim(data)[1]
  

  
  load( file.path ( PROJHOME , "Output" , "mGPS" , files[i])) # load the GPS data for start and end time
  start = data$UTC.TIME[1] # record start and end times
  
    fin = data$UTC.TIME[fin.time]
  
  f_id = str_split_fixed(files[i], "\\.", 17)[,11] # split the filename
  
  ACCfiles = list.files( file.path (PROJHOME , "Data","ACC"))
  
  a_id = str_split_fixed(ACCfiles, "\\.", 17)[,12] 
  
  j = which(a_id == f_id)
  
  
  data = ff_dba(ACCfiles[j], start, fin, smooth_type = smooth_type) # use flap freq/ dorsal body acceleration function to
 #  
 # plot( na.omit(as.numeric(data[,1][data[,1 ]<60]))[sort ( sample ( 1:length(data[,1]),2000))] )
  
  
  save(data , file= file.path( PROJHOME , "Output" , "mACC", paste0( substr(files[i], 1, nchar(files[i])- 4), ".", smooth_type, ".rda")))
  
  print(i)
}


```

```{R}
if (! file.exists( file.path(PROJHOME , "Output" , "ACC.no.file.rda"))){
  save ( no.file , file = file.path(PROJHOME , "Output" , "ACC.no.file.rda") )
}
if (! file.exists( file.path(PROJHOME , "Output" , "ACC.time.errors.rda"))){
  save ( time.errors , file = file.path(PROJHOME , "Output" , "ACC.time.errors.rda") )
}


```



# Section 2

```{R}

smooth_type = "num"

setwd( file.path(PROJHOME , "data" , "mACC"))

files = str_split_fixed(list.files(), "\\." , 18)

load( file.path( PROJHOME, "Output" , "pigeon_nums.rda"))
Arr = array(NA, c( 30, 3, 2, 16), dimnames = list(NULL, c("amp", "p_p_z", "ff"), c("group", "solo"), paste0( pigeon_nums$pigeon_nums)))




for ( i in 1:nrow(pigeon_nums)){
  
  pidge = pigeon_nums$pigeon_nums[i]
  
  fg = files.chooser( folder = "mACC", pigeon.nums = pidge, g_s = "g")
  
  fg = fg[which (str_split_fixed(fg, "\\." , 17)[,16] == smooth_type)]
  
  fs = files.chooser( folder = "mACC", pigeon.nums = pidge, g_s = "s")
  
  fs = fs[which (str_split_fixed(fs, "\\." , 17)[,16] == smooth_type)]
  
  for ( j in 1:length(fg)){
    load( file.path(PROJHOME , "data", "mACC", fg[j]))
    
    Arr[j,"amp","group",i] =    median(data[,"amp"][data[,"amp"] < 1000], na.rm = T)
    Arr[j,"p_p_z","group",i] =  median(data[,"p_p_z"], na.rm = T)
    Arr[j,"ff","group",i] = median(data[,"ff"], na.rm = T)
    
  }
  for ( j in 1:length(fs)){
    load( file.path(PROJHOME , "data", "mACC", fs[j]))
    
    Arr[j,"amp","solo",i] =    median(data[,"amp"][data[,"amp"] < 1000], na.rm = T)
    Arr[j,"p_p_z","solo",i] =  median(data[,"p_p_z"], na.rm = T)
    Arr[j,"ff","solo",i] = median(data[,"ff"], na.rm = T)
    
  }
}

```



```{R}
{
  par (mfrow = c(1,3))
  boxplot(as.vector(Arr[,"amp","group",]) ,
          as.vector(Arr[,"amp","solo",]), main = "dba (mm)", names =  c("group", "solo"))
  
  boxplot(as.vector(Arr[,"p_p_z","group",]),
          as.vector(Arr[,"p_p_z","solo",]), main = "p_p_z", names = c("group", "solo"))
  
  boxplot(as.vector(Arr[,"ff","group",]),
          as.vector(Arr[,"ff","solo",]), main = "ff",
          names = c("group", "solo"))
}
```

```{R}


id_plots = function (x, y , z = NULL, plot = c("boxplot", "plot")){
  if( x == "ff"){
    ylim = c(4,9)
  } else {
    ylim = c(10,30)
  }
  
  if ( is.null(z)){
    z = rep(1:16, each = 30)
  }
  
  if ( plot[1] == "boxplot"){
    boxplot( as.vector(Arr[,x, y,])~ z, xaxt = "n", main = y, ylab = x, ylim = ylim)
    axis(1, at = 1:16, dimnames(Arr)[[4]])
  }
  
  if ( plot[1] == "plot"){
    plot( as.vector(Arr[,x, y,])~ z, main = y, ylab = x, ylim = ylim, xlab = "" )
  }
  
}

{
  par(mfrow = c(2,1))
  id_plots("amp", "solo")
  id_plots("ff" , "solo")
}
```

```{R}
{
  par(mfrow = c(2,1))
  
  id_plots("ff", "group")
  id_plots("amp", "group")
}

```
```{R}

{
  par(mfrow = c(2,1))
  
  id_plots("ff", "solo")
  id_plots("ff", "group")
}
```

```{R}
{
  par(mfrow = c(2,1))
  
  id_plots("amp", "solo")
  id_plots("amp", "group")
}
```

```{R}

Arr2 = array(NA, c(3,3,16), dimnames = list(c("group","solo", "diff"), c("amp", "p_p_z", "ff"), paste0( pigeon_nums$pigeon_nums) ))


for ( i in 1:nrow(pigeon_nums)){
  
  Arr2["group","amp",i] = median( Arr[,"amp","group",i], na.rm = T)
  Arr2["group","p_p_z",i] = median( Arr[,"p_p_z","group",i], na.rm = T)
  Arr2["group", "ff", i] = median( Arr[ ,"ff", "group",i], na.rm = T)
  
  Arr2["solo","amp",i] = median( Arr[,"amp","solo",i], na.rm = T)
  Arr2["solo","p_p_z",i] = median( Arr[,"p_p_z","solo",i], na.rm = T)
  Arr2["solo", "ff", i] = median( Arr[ ,"ff", "solo",i], na.rm = T)
  
  Arr2["diff","amp",i] = Arr2["group","amp",i] - Arr2["solo","amp",i]
  Arr2["diff","p_p_z",i] = Arr2["group","p_p_z",i] - Arr2["solo","p_p_z",i]
  Arr2["diff","ff",i] = Arr2["group","ff",i] - Arr2["solo","ff",i]
  
}


load( file.path(PROJHOME, "Output", "morpho_delta.rda"))

mass = morpho_delta$mass[ order(morpho_delta$pigeon)]
delta = morpho_delta$delta[ order(morpho_delta$pigeon)]

{
  par( mfrow = c(2,1))
  plot( Arr2["diff","amp",] ~ morpho_delta$mass[order(morpho_delta$pigeon)], xlab = "" , ylab = "group minus solo - dba (mm)")
  plot( Arr2["diff","ff",] ~ morpho_delta$mass[order(morpho_delta$pigeon)] , ylab = "group minus solo - ff (mm)", xlab = "mass(g)")
}


```


```{R}

plot( Arr2["diff","amp",] ~ Arr2["diff","ff",] , xlab = "ff diff in group" , ylab = "dba diff in group (mm)")
```


```{R}
mass = morpho_delta$mass[order(morpho_delta$pigeon)]
mm = mean(mass)

deltamass = abs(morpho_delta$mass[order(morpho_delta$pigeon)] - mm)

{
  par(mfrow = c(2,1))
  plot(Arr2["diff","ff",] ~ deltamass , ylab = "group minus solo - ff (mm)", xlab = "delta mass(g)")
  legend("topright",legend = paste( "p = " , round(summary(lm( Arr2["diff","ff",] ~ deltamass))$coeff[2,4] , 3)))
  
  plot(Arr2["diff","amp",] ~ deltamass , ylab = "group minus solo - amp (mm)", xlab = "delta mass(g)")
  legend("topright",legend = paste( "p = " , round(summary(lm( Arr2["diff","amp",] ~ deltamass))$coeff[2,4] , 3)))
}


```

```{R}
delta = morpho_delta$delta[order(morpho_delta$pigeon)]

{
  par(mfrow = c(2,1))
  plot(Arr2["diff","ff",] ~ delta , ylab = "group minus solo - ff (mm)", xlab = "speed")
  legend("topright",legend = paste( "p = " , round(summary(lm( Arr2["diff","ff",] ~ delta ))$coeff[2,4] , 3)))
  
  plot(Arr2["diff","amp",] ~ delta , ylab = "group minus solo - amp (mm)", xlab = "speed")
  legend("topright",legend = paste( "p = " , round(summary(lm( Arr2["diff","amp",] ~ delta))$coeff[2,4] , 3)))
}
```

```{R}
{par(mfrow = c(2,1))
  vec = morpho_delta$pigeon[order(morpho_delta$delta)]
  
  
  boxplot( as.vector(Arr[,"ff" , "solo", as.character(vec)]) ~ rep(1:16, each = 30),  col = "green" ,at = seq(1,32,2), ylim = c(4,9), xlab = "pigeons in speed order", ylab = "flap frequency")
  ff =  summary( lm ( as.vector(Arr[,"ff", "solo",]  )~ rep(1:16, each = 30)))$coeff
  abline(ff[1,1], ff[2,1], col = "green")
  par(new = T)
  boxplot(  as.vector(Arr[,"ff" , "group", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,31,2), ylim = c(4,9), col = "red")
  legend( "topright", lty = 1, legend =  c("solo", "group") , col= c("green" , "red"), cex = 0.5)
  
  vec = morpho_delta$pigeon[order(morpho_delta$mass)]
  
  
  boxplot( as.vector(Arr[,"ff" , "solo", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,32,2), col = "green" ,  ylim = c(4,9), xlab = "pigeons in mass order")
  par(new = T)
  boxplot(  as.vector(Arr[,"ff" , "group", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,31,2), ylim = c(4,9), col = "red")
  
}
```

```{R}
{par(mfrow = c(2,1))
  vec = morpho_delta$pigeon[order(morpho_delta$delta)]
  
  
  boxplot( as.vector(Arr[,"amp" , "solo", as.character(vec)]) ~ rep(1:16, each = 30),  col = "green" ,at = seq(1,32,2), ylim = c(10,30), xlab = "pigeons in speed order", ylab = "flap frequency")
  amp =  summary( lm ( as.vector(Arr[,"amp", "solo",]  )~ rep(1:16, each = 30)))$coeff
  abline(amp[1,1], amp[2,1], col = "green")
  par(new = T)
  boxplot(  as.vector(Arr[,"amp" , "group", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,31,2), ylim = c(10,30), col = "red")
  legend( "topright", lty = 1, legend =  c("solo", "group") , col= c("green" , "red"), cex = 0.5)
  
  vec = morpho_delta$pigeon[order(morpho_delta$mass)]
  
  
  boxplot( as.vector(Arr[,"amp" , "solo", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,32,2), col = "green" ,  ylim = c(10,30), xlab = "pigeons in mass order")
  par(new = T)
  boxplot(  as.vector(Arr[,"amp" , "group", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,31,2), ylim = c(10,30), col = "red")
  
}
```



```{R}

m = lm(Arr2["diff","ff",] ~ delta + abs(delta) + delta:abs(delta)  )

summary(m)

plot(Arr2["diff","ff",] ~ delta , ylab = "group minus solo - ff (mm)", xlab = "speed")

summary(lm( Arr2["diff","ff",] ~ delta ))


```

```{R}

a1 = anova(lm(as.vector(Arr[,"ff" , "group", as.character(vec)]) ~ rep(1:16, each = 30)))
a2 = anova(lm(as.vector(Arr[,"amp" , "group", as.character(vec)]) ~ rep(1:16, each = 30)))

c( a1$`Pr(>F)`[1],
   a2$`Pr(>F)`[1])
```

```{R}
{
  
  boxplot( as.vector(Arr[,"amp" , "solo", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,32,2), ylim = c(10,30))
  par(new = T)
  boxplot(  as.vector(Arr[,"amp" , "group", as.character(vec)]) ~ rep(1:16, each = 30), at = seq(1,31,2), ylim = c(10,30), col = "red")
}
```

```{R}
ff =  summary( lm ( as.vector(Arr[,"ff", "solo",]  )~ rep(delta, each = 30)))$coeff
amp = summary( lm ( as.vector(Arr[,"amp", "solo",] )~ rep(delta, each = 30)))$coeff

{
  par(mfrow = c( 2 , 1 ))
  
  id_plots("ff", "solo", rep(delta,each = 30), plot = "plot")
  abline(ff[1,1], ff[2,1])
  legend( "topright", legend = paste ( "p =" ,   round(ff[2,4],4)))
  id_plots("amp", "solo", rep(delta,each = 30), plot = "plot")
  abline(amp[1,1], amp[2,1])
  legend( "topright", legend = paste ( "p =" ,   round(amp[2,4],4)))
  mtext("individual minus group speed (aka. delta speed)" , 1, line = 3)
}


```


```{R}
ff = summary( lm ( as.vector(Arr[,"ff", "group",] )~ rep(delta, each = 30)))$coeff
amp = summary( lm ( as.vector(Arr[,"amp", "group",] )~ rep(delta, each = 30)))$coeff

{
  par(mfrow = c( 2 , 1 ))
  
  id_plots("ff", "group", rep(delta,each = 30), plot = "plot")
  abline(ff[1,1], ff[2,1])
  legend( "topright", legend = paste ( "p =" ,   round(ff[2,4],4)))
  id_plots("amp", "group", rep(delta,each = 30), plot = "plot")
  abline(amp[1,1], amp[2,1])
  legend( "topright", legend = paste ( "p =" ,   round(amp[2,4],4)))
  mtext("individual minus group speed (aka. delta speed)" , 1, line = 3)
}


```


```{R}
for ( i in 1:16){
  {
    par(mar = c(5,5,5,5))
    boxplot( 0, Arr[,"ff", "solo",i], Arr[,"ff", "group",i], ylim = c(4,9),
             at = c(1,3,4), col = "green", yaxt = "n",
             bty = "n" , main =paste( "Pigeon" , names(Arr[1,1,1,])[i] ))
    axis(4, col = "green", col.ticks = "green", col.axis = "green")
    par(new = T)
    boxplot( Arr[,"amp", "solo",i], Arr[,"amp", "group",i],0, ylim = c(10,30),
             at = c(1,2,4), col = "red", yaxt = "n")
    axis(2, col = "red", col.ticks = "red", col.axis = "red")
    mtext ("Dorsal Body Amplitude (mm)", 2, line = 3, col ="red")
    mtext ( "Flap Frequency (Hz)", 4 ,line = 3 , col= "green ")
    axis(1, at = 1:4,
         labels = c("Solo DBA" , "Group DBA", "Solo FF" , "Group FF"))
  }
}

```

